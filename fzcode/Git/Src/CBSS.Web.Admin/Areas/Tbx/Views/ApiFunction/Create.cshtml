@using CBSS.Web
@{
    ViewBag.Title = "接口Create";
}
@using CBSS.Tbx.Contract.DataModel
@using CBSS.Framework.Contract.Enums
@model Sys_ApiFunction
@{
    Layout = "~/Views/Shared/_Layout.Edit.cshtml";
}
<script src="@Url.StaticFile("/assets/js/jquery-1.8.3.min.js")"></script>



<form class="form-horizontal" role="form">

    <div style="padding:5px;">
        @if (Model != null)
        {
            <div style="width:100%; text-align:center; font-size:24px; padding-top:10px;">编辑接口</div>
            <fieldset>
                <legend>接口信息</legend>
                <div class="form-group">
                    <div class="col-sm-2">
                        <input id="hidenApiFunctionID" type="hidden" value="@Model.ApiFunctionID" />
                        <input id="hidenApiFunctionWay" type="hidden" value="@Model.ApiFunctionWay" />
                        <span class="required">*</span>接口名称：
                        <input class="form-control" id="txtApiFunctionName" type="text" value="@Model.ApiFunctionName" style="width:40%;" />
                        <span class="required"></span>接口描述：
                        <input class="form-control" id="txtApiFunctionExplain" value="@Model.ApiFunctionExplain" type="text" style="width:40%;" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-2">
                        <span class="required">*</span>接口路径：
                        <input class="form-control" id="txtApiFunctionUrl" value="@Model.ApiFunctionUrl" type="text" style="width:40%;" />
                        <span class="required"></span>传输方式：
                        <select id="selApiFunctionWay">
                            @if (ViewData["ApiFuncWayEnum"] != null)
                            {
                                foreach (var item in ViewData["ApiFuncWayEnum"] as Dictionary<int, string>)
                                {
                                    <option value="@item.Key">@item.Value</option>
                                }
                            }
                            @*<option value="0">正常</option>
                                <option value="1">压缩</option>
                                <option value="2">加密</option>
                                <option value="3">压缩加密</option>*@
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-1">
                        <span class="required">*</span>系统编号：
                        <select id="selSystemCode">
                            @if (ViewData["SystemEnum"] != null)
                            {
                                foreach (var item in ViewData["SystemEnum"] as Dictionary<int, string>)
                                {
                                    if (Model.SystemCode == item.Key.ToString())
                                    {
                                        <option value="@item.Key" selected="selected">@item.Value</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Key">@item.Value</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-1">
                        <span class="required"></span>备注：
                        <textarea id="txtApiFunctionRemark" style="width:80%; min-height:100px;">@Model.ApiFunctionRemark</textarea>
                    </div>
                </div>
            </fieldset>
        }
        else
        {
            <div style="width:100%; text-align:center; font-size:24px; padding-top:10px;">新增接口</div>
                                    <fieldset>
                                        <legend>接口信息</legend>
                                        <div class="form-group">
                                            <div class="col-sm-2">
                                                <span class="required">*</span>接口名称：
                                                <input class="form-control" id="txtApiFunctionName" type="text" style="width:40%;" />
                                                <span class="required"></span>接口描述：
                                                <input class="form-control" id="txtApiFunctionExplain" type="text" style="width:40%;" />
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-sm-2">
                                                <span class="required">*</span>接口路径：
                                                <input class="form-control" id="txtApiFunctionUrl" type="text" style="width:40%;" />
                                                <span class="required"></span>传输方式：
                                                <select id="selApiFunctionWay">
                                                    @if (ViewData["ApiFuncWayEnum"] != null)
                                                    {
                                                        foreach (var item in ViewData["ApiFuncWayEnum"] as Dictionary<int, string>)
                                                        {
                                                            <option value="@item.Key">@item.Value</option>
                                                        }
                                                    }
                                                    @*<option value="0">正常</option>
                                                        <option value="1">压缩</option>
                                                        <option value="2">加密</option>
                                                        <option value="3">压缩加密</option>*@
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-sm-1">
                                                <span class="required">*</span>系统编号：
                                                <select id="selSystemCode">
                                                    @if (ViewData["SystemEnum"] != null)
                                                    {
                                                        foreach (var item in ViewData["SystemEnum"] as Dictionary<int, string>)
                                                        {
                                                            <option value="@item.Key">@item.Value</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-sm-1">
                                                <span class="required"></span>备注：
                                                <textarea id="txtApiFunctionRemark" style="width:80%; min-height:100px;"></textarea>
                                            </div>
                                        </div>
                                    </fieldset>
        }
        <fieldset>
            <legend>接口参数</legend>
            <div class="form-group">
                <div class="col-sm-2">
                    <span class="required">*</span>参数名称：
                    <input class="form-control" id="txtParameterFields" type="text" style="width:40%;" />
                    <span class="required"></span>参 数 值 ：
                    <input class="form-control" id="txtParameterValue" type="text" style="width:40%;" />
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2">
                    <span class="required"></span>父参数名：
                    <input class="form-control" id="txtApiFunctionParamParentID" type="text" style="width:40%;" />
                    <span class="required"></span>请求还是返回参数：
                    <select id="selType" style="width:10%;">
                        <option value="0">请求参数</option>
                        <option value="1">返回参数</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2">
                    <span class="required">*</span>参数类型：
                    <select id="selParameterType" style="width:41.3%;">
                        <option value="1">int</option>
                        <option value="2">string</option>
                        <option value="3">bool</option>
                        <option value="4">list</option>
                    </select>
                    <span class="required"></span>是否必填：
                    <select id="selIsAllowNull" style="width:10%;">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-3">
                    <span class="required"></span>参数描述：
                    <input class="form-control" id="txtParameterExplain" type="text" style="width:40%;" />
                    <input type="button" id="btnAddParam" value="添加参数" class="btn btn-primary blue" style="margin-left:70px; margin-top: -10px;" />
                </div>
            </div>
        </fieldset>
        <table id="tbParam" class="table table-striped table-hover ">
            <tr>
                <th>
                    父参数名
                </th>
                <th>
                    参数名
                </th>
                <th>
                    参数描述
                </th>
                <th class="hidden-480">
                    参数值
                </th>
                <th class="hidden-480" style="display:none;">
                    参数类型
                </th>
                <th>
                    是否必填
                </th>
                <th>
                    请求返回参数
                </th>
                <th>
                    操作
                </th>
            </tr>
            @if (ViewData["ApiFunctionParam"] != null)
            {
                var list = ViewData["ApiFunctionParam"] as List<Sys_ApiFunctionParam>;
                foreach (var item in list)
                {
                    <tr>
                        <td>@item.ApiFunctionParamParentID</td>
                        <td>@item.ParameterFields</td>
                        <td>@item.ParameterExplain</td>
                        <td>@item.ParameterValue</td>
                        <td style="display:none;">@item.ParameterType</td>
                        <td>@(item.IsAllowNull == 0 ? "否" : "是")</td>
                        <td>@(item.Type == 0 ? "请求参数" : "返回参数")</td>
                        <td>
                            <a href="javascript:;void(0)" onclick="DelRow(this)">删除</a>
                            <a href="javascript:void(0)" onclick="ParamEdit(this)">编辑</a>
                        </td>
                    </tr>
                }
            }
            @for (int i = 0; i < 0; i++)
            {
                <tr>
                    <td>a</td>
                    <td>a</td>
                    <td>a</td>
                    <td>a</td>
                    <td>a</td>
                    <td>a</td>
                    <td>adsafdasfa...</td>
                    <td>
                        <a href="javascript:void(0)">删除</a>
                        <a href="javascript:void(0)">编辑</a>
                    </td>
                </tr>
            }
        </table>
    </div>
</form>

<script type="text/javascript">
    $(function () {
        var hidenApiFunctionWay = $("#hidenApiFunctionWay").val();
        if (hidenApiFunctionWay == undefined) {
            hidenApiFunctionWay = 0;
        }
        $("#selApiFunctionWay").val(hidenApiFunctionWay);
        //添加参数信息
        $("#btnAddParam").click(function () {
            var txtParameterFields = $("#txtParameterFields").val();
            var txtParameterValue = $("#txtParameterValue").val();
            var txtApiFunctionParamParentID = $("#txtApiFunctionParamParentID").val();
            var selType = $("#selType").val() == 0 ? "请求参数" : "返回参数";
            var selParameterType = $("#selParameterType").val();
            var selIsAllowNull = $("#selIsAllowNull").val() == 0 ? "否" : "是";
            var txtParameterExplain = $("#txtParameterExplain").val();
            if (txtParameterFields == "") {
                alert('参数名称不能为空！');
                return false;
            }
            var rows = " <tr> " +
                "<td>" + txtApiFunctionParamParentID + "</td>" +
                "<td>" + txtParameterFields + "</td>" +
                "<td>" + txtParameterExplain + "</td>" +
                "<td>" + txtParameterValue + "</td>" +
                "<td style='display:none'>" + selParameterType + "</td>" +
                "<td>" + selIsAllowNull + "</td>" +
                "<td>" + selType + "</td>" +
                "<td>" +
                "<a href='#'onclick='javascript:$(this).parent().parent().remove();'>删除 </a>" +
                "<a href='#' onclick='ParamEdit(this)'> 编辑</a>" +
                "</td>" +
                "</tr>";
            $("#tbParam").append(rows);
        });
        //提交接口和参数信息
        $("#submit").click(function () {
            //接口信息
            var txtApiFunctionName = $("#txtApiFunctionName").val().trim();
            var txtApiFunctionExplain = $("#txtApiFunctionExplain").val().trim();
            var txtApiFunctionUrl = $("#txtApiFunctionUrl").val().trim();
            var selApiFunctionWay = $("#selApiFunctionWay").val();
            var selSystemCode = $("#selSystemCode").val();
            var txtApiFunctionRemark = $("#txtApiFunctionRemark").val();
            //接口参数
            var paramList = new Array();
            var rows = $("#tbParam").find("tr");
            for (var i = 1; i < rows.length; i++) {
                var cols = rows.eq(i).find("td");
                paramList.push({
                    "ApiFunctionParamParentID": cols.eq(0).text(), "ParameterFields": cols.eq(1).text(), "ParameterExplain": cols.eq(2).text()
                    , "ParameterValue": cols.eq(3).text(), "ParameterType": cols.eq(4).text(), "IsAllowNull": cols.eq(5).text() == "是" ? 1 : 0
                    , "Type": cols.eq(6).text() == "请求参数" ? 0 : 1
                });
            }
            if (txtApiFunctionName == "") {
                alert('接口名称不能为空！');
                return false;
            }
            if (txtApiFunctionUrl == "") {
                alert('接口路径不能为空！');
                return false;
            } if (paramList.length == 0) {
                alert('接口参数不能为空！');
                return false;
            }
            var ID = $("#hidenApiFunctionID").val();
            if (ID == undefined) {
                ID = 0;
            }
            var apiFuc = "ApiFunctionID=" + ID + "&txtApiFunctionName=" + txtApiFunctionName + "&txtApiFunctionExplain=" + txtApiFunctionExplain + "&txtApiFunctionUrl="
                + txtApiFunctionUrl + "&selApiFunctionWay=" + selApiFunctionWay + "&selSystemCode=" + selSystemCode + "&txtApiFunctionRemark=" + txtApiFunctionRemark + "";
            $.post("/ApiFunction/Add?" + apiFuc, { jsonData: JSON.stringify(paramList) }, function (myData) {
                //alert(myData);
                if (myData) {
                    alert('操作成功！');
                    parent.location.reload(1);
                    //window.location.href = "/ApiFunction/Index";
                } else {
                    alert('操作失败！');
                }
            });
        });
    });
    function DelRow(obj) {
        $(obj).parent().parent().remove();
    }
    //编辑参数
    function ParamEdit(obj) {
        var rowHtml = $(obj).parent().parent().children("td");
        if ($(obj).text().trim() == "编辑") {
            $("#txtApiFunctionParamParentID").val(rowHtml.eq(0).text());
            $("#txtParameterFields").val(rowHtml.eq(1).text());
            $("#txtParameterExplain").val(rowHtml.eq(2).text());
            $("#txtParameterValue").val(rowHtml.eq(3).text());
            $("#selParameterType").val(rowHtml.eq(4).text());
            $("#selIsAllowNull").val(rowHtml.eq(5).text() == "否" ? 0 : 1);
            $("#selType").val(rowHtml.eq(6).text().trim() == "请求参数" ? 0 : 1);
            $(obj).text("保存");
        } else {    //保存
            rowHtml.eq(0).text($("#txtApiFunctionParamParentID").val());
            rowHtml.eq(1).text($("#txtParameterFields").val());
            rowHtml.eq(2).text($("#txtParameterExplain").val());
            rowHtml.eq(3).text($("#txtParameterValue").val());
            rowHtml.eq(4).text($("#selParameterType").val());
            rowHtml.eq(5).text($("#selIsAllowNull").val() == 0 ? "否" : "是");
            rowHtml.eq(6).text($("#selType").val() == 0 ? "请求参数" : "返回参数");
            $(obj).text("编辑");
        }
    }
</script>
