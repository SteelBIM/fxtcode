@using CBSS.Framework.Contract
@using CBSS.Framework.Web.Controls
@using CBSS.Tbx.Contract.DataModel
@using CBSS.Web
@model  MarketBook
@{
    Layout = "~/Views/Shared/_Layout.Edit.cshtml";
}

@section MainContent{
    <div class="portlet-body form-horizontal form-bordered form-row-stripped">
        <div class="row-fluid">

            <div class="control-group">
                <label class="control-label"><span class="required">*</span>市场分类：</label>
                <div class="controls">
                    @Html.TextBoxFor(o => o.MarketClassifyId, new { @onclick = "Classifies()", @style = "display:none" })
                    <input readonly="readonly" onclick="Classifies()" id="MarketClassifyName" value="@ViewBag.MarketClassifyName" type="text" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><span class="required">*</span>学段：</label>
                <div class="controls">
                    @Html.DropDownListFor(o => o.Stage, new List<SelectListItem> { new SelectListItem { Text = "小学", Value = "2" }, new SelectListItem { Text = "初中", Value = "4" }, new SelectListItem { Text = "高中", Value = "8" } }, new { onchange = "GetBookList()" })
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">MOD书籍：</label>
                <div class="controls">
                    <select id="books" onchange="ChangeModBook()" name="MODBookID">
                        <option value="">请选择</option>
                        @if (Model.MODBookID > 0)
                        {
                            <option selected="selected" value="@Model.MODBookID">@Model.MODBookName</option>
                        }
                    </select>

                    @Html.HiddenFor(o => o.MODBookName)
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><span class="required">*</span>书籍名称：</label>
                <div class="controls">
                    @Html.HiddenFor(o => o.MarketBookID)

                    @Html.TextBoxFor(m => m.MarketBookName, new { @placeholder = "不填将使用MOD书籍名", @class = "m-wrap small", @style = "min-width:205px;" })
                    <span class="help-inline">@Html.ValidationMessageFor(m => m.MarketBookName)</span>
                    <input type="button" onclick="UseModName()" class="btn green" value="使用MOD名称" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><span class="required">*</span> 图书编号：</label>
                <div class="controls">
                    @Html.TextBoxFor(m => m.ISBN, new { @class = "m-wrap small", @style = "min-width:205px;" })
                    <span class="help-inline">@Html.ValidationMessageFor(m => m.ISBN)</span>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><span class="required">*</span>书籍封面：</label>
                <div class="controls">
                    @Html.HiddenFor(o => o.MODBookCover)
                    @Html.TextBoxFor(m => m.MarketBookCover, new { @placeholder = "不填将使用MOD封面", @class = "m-wrap small" })
                    <input type="button" onclick="UseModCover()" class="btn green" value="使用MOD封面" />
                    @*<span class="help-inline">@Html.ValidationMessageFor(m => m.MarketBookName)</span>*@
                    <div id="OssUploadControl">
                        <div id="ossfile">你的浏览器不支持flash,Silverlight或者HTML5！</div>
                        <br />
                        <div id="container" style="border:0px;">
                            <a id="selectfiles" href="javascript:void(0);" class='btn' style="background-color:#35AA47;">选择文件</a>
                            <a id="postfiles" href="javascript:void(0);" class='btn' style="background-color:#35AA47;">开始上传</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group" style="display:none">
                <label class="control-label">MOD书籍：</label>
                <div style="color:red" class="controls" onclick="ChangeModDiv()">
                    <input id="fromMod" type="checkbox" @(Model.MODBookID > 0 ? "checked" : "") />&nbsp;&nbsp;提示：使用MOD数据必须勾选该项
                </div>
            </div>
            <div id="mod" style="border-top-color:gray;border-top:solid;border-width:1px;display:none">
                <div class="control-group">
                    <label class="control-label">MOD学科：</label>
                    <div class="controls">
                        <select id="subjects" onchange="GetVersionList()"></select>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">MOD版本：</label>
                    <div class="controls">
                        <select id="versions" onchange="GetBookList()"><option value="">请选择</option></select>
                    </div>
                </div>
            </div>

            <div class="form-actions navbar-fixed-bottom">
                <button onclick="return CheckDate()" type="submit" id="submit1" class="btn blue" style="float:right;"><i class="icon-ok"></i> 提交</button>
                <span id="submitloading" style="display:none;"><img src="@Url.Content("~/content/images/loading.gif")"></span>
                <button type="button" class="btn" id="cancel" style="float:right; margin-right:10px;">撤销</button>
                <div class="validation-summary-valid" data-valmsg-summary="true">
                    <ul>
                        <li style="display:none"></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="panel-body" style="padding-bottom:0px;">
            <table id="tb_classifies"></table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        </div>
    </div>
    <input type="hidden" id="serverUrl" value="@Url.Action("GetClassifiesJson","MarketClassify")" />
    <input type="hidden" id="getClassify" value="@Url.Action("GetClassfiy","MarketClassify")" />
    <input type="hidden" id="delUrl" value="@Url.Action("DeleteClassify","MarketClassify")" />
    <input type="hidden" id="getFullName" value="@Url.Action("GetFullName","MarketClassify")" />
}
<link href="@Url.StaticFile("/assets/aliyunupload/OssUploadControl.css")" rel="stylesheet" />
@section PageSpecificJavascriptIncludes{
    <link href="~/Content/Scripts/bootstrap-table-develop/src/bootstrap-table.css" rel="stylesheet" />
    <script>
        $.ajaxSetup({ async: false });
    </script>
    <script src="~/Content/Scripts/bootstrap-table-develop/src/bootstrap-table.js"></script>
    <script src="~/Content/Scripts/bootstrap-table-develop/src/locale/bootstrap-table-zh-CN.js"></script>
    <script src="~/Assets/pages/MarketClassifySelect.js"></script>

    <script src="@Url.StaticFile("/assets/aliyunupload/lib/crypto1/crypto/crypto.js")"></script>
    <script src="@Url.StaticFile("/assets/aliyunupload/lib/crypto1/hmac/hmac.js")"></script>
    <script src="@Url.StaticFile("/assets/aliyunupload/lib/crypto1/sha1/sha1.js")"></script>
    <script src="@Url.StaticFile("/assets/aliyunupload/plupload.js")"></script>
    <script src="@Url.StaticFile("/assets/aliyunupload/bookupload.js")"></script>
    <script>

        function Classifies() {
            $("#editModal").modal();
            oTableInit.Init();
        }
        function UseModCover() {
            $("#MarketBookCover").val("");
        }
        function UseModName() {
            $("#MarketBookName").val("");
        }

        function ChangeModBook() {
            var modBookName = $("#books").find("option:selected").text();
            $("#MODBookName").val(modBookName);
        }
        function GetSubjectList() {
            $.post("@Url.Action("GetSubjectList")", {}, function (data) {
                if (data) {
                    var optionHtml = "<option>请选择</option>";
                    $(data).each(function () {
                        optionHtml += '<option value="' + this.MarketClassifyName + '">' + this.MarketClassifyName + '</option>';
                    })
                    $("#subjects").html(optionHtml);
                }
            });
        }

        function GetVersionList() {
            $.post("@Url.Action("GetVersionList")", { subject: $("#subjects").val(), stage: $("#Stage").val() }, function (data) {
                if (data) {
                    var optionHtml = "<option>请选择</option>";
                    $(data).each(function () {
                        optionHtml += '<option value="' + this.MODID + '">' + this.ModClassifyName + '</option>';
                    })
                    $("#versions").html(optionHtml);
                }
            });
        }

        function GetBookList() {
            $.post("@Url.Action("GetMODBooksByMarketClassify")", { classifyID: $("#MarketClassifyId").val(), stage: $("#Stage").val() }, function (data) {
                if (data) {
                    var optionHtml = "<option value=''>请选择</option>";
                    $(data.Data).each(function () {
                        optionHtml += '<option value="' + this.MODBookID + '">' + this.MODBookFullName + '</option>';
                    })
                    $("#books").html(optionHtml);
                }
            });
        }

        function ChangeModDiv() {
            $("#subjects").val("");
            $("#versions").val("");
            $("#books").val("");
            //if ($("#fromMod").prop("checked")) {
            //    $("#mod").show();
            //} else {
            //    $("#mod").hide();
            //}
        }

        function CheckDate() {
            if ($("#MarketClassifyId").val() == "" || $("#MarketClassifyId").val() <= 0) {
                parent.bootbox.alert("请选择分类");
                return false;
            }

            if ($("#books").val() == "" || $("#books").val() == "请选择") {
                if ($("#MarketBookName").val() == "") {
                    parent.bootbox.alert("非mod书籍必须填写书籍名称");
                    return false;
                }
                if ($("#MarketBookCover").val() == "") {
                    parent.bootbox.alert("非mod书籍必须上传封面");
                    return false;
                }
            }

            return true;
        }

        $(function () {
            GetBookList($("#MarketClassifyId").val());
            $("#books").val("@Model.MODBookID");
         //   GetSubjectList();
            //if ($("#fromMod").prop("checked")) {
            //    $("#mod").show();
            //} else {
            //    $("#mod").hide();
            //}
            $("#submit").parent().hide();
        })
    </script>
}
