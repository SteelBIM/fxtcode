@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .row1 {
        margin-left: 30px;
    }
        .row1 label {
            margin-bottom: 0;
            width: 150px;
        }

        .row1 .form-group {
            margin-bottom: 15px;
        }
</style>
<div id="toolbar" class="input-group" style="float: left;margin-top: 0;margin-bottom: 0;">
    @if (ViewBag.Add)
    {
        <button class="btn green" onclick="AddParent()" type="button"><span class="glyphicon glyphicon-export" aria-hidden="true"></span>新增分类 <i class="icon-plus icon-white"></i></button>
    }
    @if (ViewBag.MarketClassify_SyncModClassify)
    {
        <button class="btn red" onclick="LoadMODClassify()" type="button"><span class="glyphicon glyphicon-export" aria-hidden="true"></span>同步MOD分类 </button>
    }
</div>
<div class="panel-body" style="padding-bottom:0px;">
    <table id="tb_classifies"></table>
</div>
<input type="hidden" id="serverUrl" value="@Url.Action("GetClassifiesJson")" />
<input type="hidden" id="getClassify" value="@Url.Action("GetClassfiy")" />
<input type="hidden" id="delUrl" value="@Url.Action("DeleteClassify")" />
<div style="clear:both"></div>

<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <span style="font-size:16px;" id="myModalLabel">编辑分类</span>
            </div>
            <div class="modal-body">
                <div class="row row1">
                    <div class="col-lg-12">
                        <form style="margin-left:-20px" action="@Url.Action("Submit")" class="form-horizontal" role="form" id="formEdit">
                            <input type="hidden" name="MarketClassifyID" id="MarketClassifyID" />
                            <input type="hidden" name="ParentId" id="ParentId" />
                            <input type="hidden" id="ParentName" />
                          
                            <div id="markettypehtml">
                                <label class="col-lg-3" style="text-align:right;float:left">市场分类名称：</label>
                                <div class="form-group">
                                    <div class="col-lg-8">
                                        <select class="form-control" name="MarketID" id="MarketID">
                                            <option value="">请选择</option>
                                            <option value="1">同步教材 </option>
                                            <option value="2">老MOD同步教材</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                          
                            <div id="parenttypehtml" style="clear:both;">
                                <label class="col-lg-3" style="text-align:right;float:left">上级分类名称：</label>
                                <div class="form-group">
                                    <div class="col-lg-8">
                                       <span id="parenttypename"></span>
                                    </div>
                                </div>
                            </div>

                            <label class="col-lg-3" style="text-align:right;float:left">类型：</label>
                            <div class="form-group">
                                <div class="col-lg-8">
                                    @*1学科2版本3年级4册别5学段*@
                                    <select class="form-control" onchange="ModTypeChange()" id="MODType" name="MODType">
                                        <option value="">请选择</option>
                                        <option value="1">学科</option>
                                        <option value="2">版本</option>
                                        <option value="3">年级</option>
                                        <option value="4">册别</option>
                                        <option value="5">学段</option>
                                        <option value="6">子版本(自定义)</option>
                                    </select>
                                </div>
                            </div>
                            @*<label class="col-lg-3" style="text-align:right;float:left;">使用MOD名称：</label>
                                <div class="form-group">
                                    <div class="col-lg-8" onclick="UseModName()">
                                        <input id="fromMod" type="checkbox" />
                                    </div>
                                </div>*@
                            <div id="modIdDiv">
                                <label id="modIdLabel" class="col-lg-3" style="text-align:right;float:left">MOD分类：</label>
                                <div class="form-group">
                                    <div class="col-lg-8">
                                        <select id="MODID" onchange="SetModName()" name="MODID"><option value="0">无</option></select>
                                    </div>
                                </div>
                            </div>
                            <label class="col-lg-3" style="text-align:right;float:left;">自定义分类名称：</label>
                            <div class="form-group">
                                <div class="col-lg-8">
                                    <input placeholder="不填将使用MOD名称" class="m-wrap small" style=" height:28px; padding:2px;" name="MarketClassifyName" id="MarketClassifyName" />
                                    <input type="button" id="UseModNameBtn" onclick="UseModName()" class="btn green" value="使用mod名称" />
                                    <font style="font-size:4px"></font>
                                </div>
                            </div>
                            <input type="hidden" id="ModClassifyName" name="ModClassifyName" />
                            @*<input type="hidden" id="MODID" name="MODID" />*@
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="submitForm()" class="btn btn-primary" id="btn_editSave">保存</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

@section PageSpecificJavascriptIncludes{
    <link href="~/Content/Scripts/bootstrap-table-develop/src/bootstrap-table.css" rel="stylesheet" />
    <script src="~/Content/Scripts/bootstrap-table-develop/src/bootstrap-table.js"></script>
    <script src="~/Content/Scripts/bootstrap-table-develop/src/locale/bootstrap-table-zh-CN.js"></script>
    <script src="~/Assets/pages/MarketClassify.js?v=1.1"></script>
    <script src="~/Assets/jquery-validation/lib/jquery.form.js"></script>
    <script>
        //$.ajaxSetup({ async: false });
        $(function () {
            var add = '@ViewBag.Add';
            var edit = '@ViewBag.Edit';
            var del = '@ViewBag.Del';
            oTableInit.Init(add, edit, del);
            ModTypeChange();
        });
        function UseModName() {
            $("#MarketClassifyName").val("");
        }

        function SetModName() {
            var text = $("#MODID").find("option:selected").text();
            $("#ModClassifyName").val(text);
        }

        //function SetCheckbox() {
        //    if ($("#MarketClassifyName").val()=="") {
        //        $("#fromMod").prop("checked", "true");
        //    } else {
        //        $("#fromMod").prop("checked", "false");
        //    }
        //}

        function ModTypeChange() {
            var MODType = $("#MODType").val();
            if (MODType == null && MODType == "")
                MODType = 0;
            if ($("#MODType").val()> 2) {
                $("#modIdLabel").hide();
                $("#modIdDiv").hide();
                $("#UseModNameBtn").hide();
                $("#MarketClassifyName").removeAttr("placeholder");
                $("#MODID").val(0);
            } else {
                $("#modIdLabel").show();
                $("#UseModNameBtn").show();
                $("#modIdDiv").show();
                $("#MarketClassifyName").attr("placeholder","不填将使用MOD名称");
            }
        }



        function InitModClassify(MODID) {
            if ($("#ParentId").val() >0) {//获取版本
                GetVersionList(MODID);
            }
            else{//获取学科
                GetSubjectList(MODID);
            }
        }


        function GetSubjectList(MODID) {
            $.post("@Url.Action("GetSubjectList", "MarketBook")", {}, function (data) {
                if (data) {
                    var optionHtml = "<option value=0>请选择</option>";
                    $(data).each(function () {
                        optionHtml += '<option value="' + this.MODID + '">' + this.MarketClassifyName + '</option>';
                    })
                    $("#MODID").html(optionHtml);
                    $("#MODID").val(MODID);
                    var text = $("#MODID").find("option:selected").text();
                    $("#ModClassifyName").val(text);
                }
            });
        }

        function GetVersionList(MODID) {
              var subjectName = "英语";
              var subject = $("#ParentName").val();
              if (subject) {
                  if (subject.lastIndexOf("英语") > -1) {
                      subjectName = "英语";
                  } else if (subject.lastIndexOf("语文") > -1) {
                      subjectName = "语文";
                  } else if (subject.lastIndexOf("数学") > -1) {
                      subjectName = "数学";
                  }
              }

              $.post("@Url.Action("GetVersionList", "MarketBook")", { subject: subjectName }, function (data) {
                if (data) {
                    var optionHtml = "<option value=0>请选择</option>";
                    $(data).each(function () {
                        optionHtml += '<option value="' + this.MODID + '">' + this.ModClassifyName + '</option>';
                    })
                    $("#MODID").html(optionHtml);
                    $("#MODID").val(MODID);
                    var text = $("#MODID").find("option:selected").text();
                    $("#ModClassifyName").val(text);
                }
            });
        }

          function LoadMODClassify() {
              bootbox.alert("正在同步中,请勿执行其他操作");
              $.post("@Url.Action("GetClassifiesAndBooks")", {}, function (data) {
                  bootbox.hideAll();
                  if (data.Success) {
                      bootbox.alert("同步完成");
                  } else {
                      bootbox.alert("同步失败");
                  }
              });
          }
    </script>
}
