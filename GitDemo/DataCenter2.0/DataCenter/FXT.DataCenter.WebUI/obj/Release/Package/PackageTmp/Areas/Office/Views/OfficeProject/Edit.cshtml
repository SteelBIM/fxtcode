@model FXT.DataCenter.Domain.Models.DatProjectOffice
@{
    ViewBag.Title = "办公楼盘";
}

@section StyleSheet{
    <style type="text/css">
        #tbInputCon
        {
            margin-top: 10px;
            margin-left: 30px;
            width: 95%;
            font-size: 14px;
            font-weight: normal;
            line-height: 20px;
            font-family: "Microsoft Yahei", "微软雅黑", "宋体", "Simsun", "Open Sans";
        }

        .required
        {
            color: red;
        }

        .btn
        {
            margin-bottom: 10px;
        }
    </style>

}
@section JavaScript{
    <!--//百度地图的文件-->
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
    <script src="@Url.Content("~/Content/layer-v1.7.1/layer/layer.min.js")" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#StartDate,#StartEndDate,#EndDate,#SaleDate").datepicker({ format: "yyyy-mm-dd" });

            //面包屑导航
            $("#navigation .breadcrumb li:eq(1)").remove();
            $("#navigation .breadcrumb li:eq(2)").remove();
            var html = "<li><span><a href=\"javascript:history.go(-1);\">办公基础数据</a></span> <i class=\"icon-angle-right\"></i></li>";
            if ('@Model' == "") {
                html += "<li><span>办公楼盘新增</span></li>";
            } else {
                html += "<li><span>办公楼盘编辑</span></li>";
            }
            $("ul.breadcrumb").append(html);

            //行政区商圈联动
            $("#AreaId").change(function () {
                var areaIdOther = "@ViewBag.areaIdOther";
                var subAreaIdOther = "@ViewBag.subAreaIdOther";
                var subAreaNameOther = "@ViewBag.subAreaNameOther";
                $.post('@Url.Action("GetSubAreaName")', { areaId: $("#AreaId").val(), areaIdOther: areaIdOther, subAreaIdOther: subAreaIdOther, subAreaNameOther: subAreaNameOther }, function (data) {
                    $("#SubAreaId").html("");
                    $.each(data, function (i, item) {
                        $("#SubAreaId").append($("<option></option>").val(item.Value).html(item.Text));
                    });
                });
            });

            $("#ProjectName").bind("change", function () {
                $.post('@Url.Action("GetProjectNamePinYin")', { ProjectName: $("#ProjectName").val() }, function (data) {
                    $("#PinYin").val(data.PinYin);
                    $("#PinYinAll").val(data.PinYinAll);
                });
            });

            //确定
            $("#btnSave").bind("click", function () {
                var areaId = $("#AreaId").val();
                var subAreaId = $("#SubAreaId").val();
                var projectId = $("#ProjectId").val() ? $("#ProjectId").val() : -1;
                var projectName = $.trim($("#ProjectName").val());
                var startdate = $.trim($("#StartDate").val());
                var startenddate = $.trim($("#StartEndDate").val());

                if (areaId == -1 || projectName == "") {
                    if (areaId == -1) {
                        $("#msgForAreaId").text("*必选");
                    }
                    else {
                        $("#msgForAreaId").text("*");
                    }
                    if (projectName == "") {
                        $("#msgForProjectName").text("*必填");
                    }
                    else {
                        $("#msgForProjectName").text("*");
                    }
                    return;
                }
                else {
                    $("#msgForAreaId").text("*");
                    $("#msgForProjectName").text("*");
                }
                if (startdate != null || startenddate != null || startdate != "" || startenddate != "") {
                    if (Date.parse(startenddate) - Date.parse(startdate) < 0) {
                        alert("土地终止日期不得小于土地起始日期！")
                        return false;
                    }
                }

                $.post('@Url.Action("IsExistProjectOffice")', { areaId: areaId, projectId: projectId, projectName: projectName }, function (data) {
                    if (data) {
                        alert("该办公楼盘已存在");
                    } else {
                        $("#mainForm").submit();
                    }
                });
            });

            //加载百度地图
            initBaiduMap();
        });

        function initBaiduMap() {
            var cityX = "@ViewBag.CityX";
            var cityY = "@ViewBag.CityY";

            var lay, //弹出层
                map, //地图对象
                initLngAndLat = [{ Lng: cityX, Lat: cityY }], //初始化经纬度、默认深圳
                clickLngAndLat = []; //保存坐标的数组
            var currentCity = "深圳"; //初始三维城市、默认深圳

            //坐标拾取
            $("#GetCoordinate").click(function () {
                lay = $.layer({
                    type: 1,
                    title: false,
                    closeBtn: false,//控制层右上角关闭按钮。closeBtn的值分别为: [关闭按钮的风格（支持0和1）, true]若不想显示关闭按钮，配置 closeBtn: false即可
                    border: [5, 0.5, '#666', true],
                    offset: ['0px', ''],
                    move: ['.xubox_title', false],
                    area: ['860px', '500px'],
                    page: {
                        dom: "#baidumap"
                    },
                    success: function () {
                        layer.shift('top', 500);
                    }
                });

                var x = $.trim($("#X").val());
                var y = $.trim($("#Y").val());
                if (x != null && x != "" && y != null && y != "") {
                    clickLngAndLat.push({ Lng: x, Lat: y });
                }

                map = new BMap.Map("container"); //加载地图
                map.clearOverlays(); //清除标注
                var navigationControl = new BMap.NavigationControl({
                    // 靠左上角位置
                    anchor: BMAP_ANCHOR_TOP_LEFT,
                    // LARGE类型
                    type: BMAP_NAVIGATION_CONTROL_LARGE
                });
                map.addControl(navigationControl);
                map.addControl(new BMap.MapTypeControl()); //添加地图类型控件

                var point;
                if (clickLngAndLat.length > 0) { //如果是编辑状态，则加载已有坐标。否，加载默认坐标
                    point = new BMap.Point(clickLngAndLat[0].Lng, clickLngAndLat[0].Lat);
                } else {
                    point = new BMap.Point(initLngAndLat[0].Lng, initLngAndLat[0].Lat);
                }

                var marker = new BMap.Marker(point); // 创建标注
                map.addOverlay(marker); // 将标注添加到地图中
                map.centerAndZoom(point, 15);
                map.setCurrentCity(currentCity);
                map.enableScrollWheelZoom();

                map.addEventListener("click", function (e) {
                    map.setDefaultCursor("pointer"); //设置鼠标手势
                    clickLngAndLat = [];
                    map.clearOverlays(); //清除除标注
                    var jsonStr = { Lng: e.point.lng, Lat: e.point.lat };
                    clickLngAndLat.push(jsonStr);
                    point = new BMap.Point(clickLngAndLat[0].Lng, clickLngAndLat[0].Lat);
                    //map.centerAndZoom(point, 18);
                    //map.enableScrollWheelZoom();
                    $("#txtlatitude").val("").val(e.point.lat);
                    $("#txtlongitude").val("").val(e.point.lng);
                    var marker = new BMap.Marker(point); // 创建标注
                    map.addOverlay(marker); // 将标注添加到地图中
                    //marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
                });

                if (clickLngAndLat.length > 0) {
                    $("#txtlatitude").val("").val(clickLngAndLat[0].Lat);
                    $("#txtlongitude").val("").val(clickLngAndLat[0].Lng);
                }
            });

            //坐标拾取--确定
            $("#btn_xy").click(function () {
                if (clickLngAndLat != null && clickLngAndLat.length > 0) {
                    $("#X").val("").val(clickLngAndLat[0].Lng);
                    $("#Y").val("").val(clickLngAndLat[0].Lat);
                    map.clearOverlays();
                }
                layer.close(lay);
            });

            //坐标拾取--取消
            $("#btnClrearCallout").click(function () {
                clickLngAndLat = [];
                map.clearOverlays();
                layer.close(lay);
            });

            //搜索
            $("#areaSearch").click(function () {
                // 创建地址解析器实例
                var myGeo = new BMap.Geocoder();
                var searchTxt = $("#txtarea").val();
                if ($.trim(searchTxt) == null || $.trim(searchTxt) == "") {
                    layer.alert("请输入搜索条件");
                    return false;
                }
                // 将地址解析结果显示在地图上，并调整地图视野
                myGeo.getPoint(searchTxt, function (point) {
                    if (point) {
                        map.centerAndZoom(point, 15);
                        $("#txtlatitude").val('').val(point.lat);
                        $("#txtlongitude").val('').val(point.lng);
                        //var pointMarker = new BMap.Point(point.lng, point.lat);
                        //map.addOverlay(new BMap.Marker(point));                          
                        map.setCurrentCity(searchTxt);
                    } else
                        layer.alert("搜索不到结果");
                }, "全国");
            });
        }

    </script>
}

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "mainForm" }))
{
    <table id="tbInputCon" class="tbInputCon">
        <tr>
            <td>行政区:
            </td>
            <td>
                @if (Model != null)
                {
                    @Html.HiddenFor(m => m.ProjectId)
                    @Html.HiddenFor(m => m.CityId)
                    @Html.HiddenFor(m => m.FxtCompanyId)
                }
                @Html.DropDownListFor(m => m.AreaId, ViewBag.AreaName as List<SelectListItem>)
                <span class="required" id="msgForAreaId">*</span>
            </td>
            <td>商务中心:
            </td>
            <td>
                @Html.DropDownListFor(m => m.SubAreaId, ViewBag.SubAreaName as List<SelectListItem>, new { Value = @ViewBag.SubAreaNameother })
            </td>
        </tr>
        <tr>
            <td>办公楼盘：
            </td>
            <td>
                @Html.TextBoxFor(m => m.ProjectName)
                <span class="required" id="msgForProjectName">*</span>
            </td>
            <td>别名：
            </td>
            <td>
                @Html.TextBoxFor(m => m.OtherName)
            </td>
        </tr>
        <tr>
            <td>与商务中心关联度：
            </td>
            <td>
                @Html.DropDownListFor(m => m.CorrelationType, ViewBag.CorrelationTypeName as List<SelectListItem>)
            </td>
            <td>主要用途：
            </td>
            <td>
                @Html.DropDownListFor(m => m.PurposeCode, ViewBag.PurposeCodeName as List<SelectListItem>)
            </td>
        </tr>
        <tr>
            <td>宗地号:
            </td>
            <td>
                @Html.TextBoxFor(m => m.FieldNo)
            </td>
            <td>地址:
            </td>
            <td>
                @Html.TextBoxFor(m => m.Address)
            </td>
        </tr>
        <tr>
            <td>土地起始日期:
            </td>
            <td>
                @Html.TextBoxFor(m => m.StartDate, new { Value = string.Format("{0:yyyy-MM-dd}", @Model == null ? null : @Model.StartDate) })
            </td>
            <td>
                土地终止日期:
            </td>
            <td>
                @Html.TextBoxFor(m => m.StartEndDate, new { Value = string.Format("{0:yyyy-MM-dd}", @Model == null ? null : @Model.StartEndDate) })
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.UsableYear)
            </td>
        </tr>
        <tr>
            <td>土地面积(㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.LandArea)
            </td>
            <td>总建筑面积(㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.BuildingArea)
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.LandArea)
            </td>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.BuildingArea)
            </td>
        </tr>
        <tr>
            <td>容积率:
            </td>
            <td>
                @Html.TextBoxFor(m => m.CubageRate)
            </td>
            <td>绿化率(%):
            </td>
            <td>
                @Html.TextBoxFor(m => m.GreenRate)
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.CubageRate)
            </td>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.GreenRate)
            </td>
        </tr>
        <tr>
            <td>总栋数(栋):
            </td>
            <td>
                @Html.TextBoxFor(m => m.BuildingNum)
            </td>
            <td>建筑类型:
            </td>
            <td>
                @Html.DropDownListFor(m => m.BuildingType, ViewBag.BuildingTypeName as List<SelectListItem>)
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.BuildingNum)
            </td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>竣工时间:
            </td>
            <td>
                @Html.TextBoxFor(m => m.EndDate, new { Value = string.Format("{0:yyyy-MM-dd}", @Model == null ? null : @Model.EndDate) })
            </td>
            <td>销售时间:
            </td>
            <td>
                @Html.TextBoxFor(m => m.SaleDate, new { Value = string.Format("{0:yyyy-MM-dd}", @Model == null ? null : @Model.SaleDate) })
            </td>
        </tr>
        <tr>
            <td>等级:
            </td>
            <td>
                @Html.DropDownListFor(m => m.OfficeType, ViewBag.OfficeTypeName as List<SelectListItem>)
            </td>
            <td>办公面积(㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.OfficeArea)
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.OfficeArea)
            </td>
        </tr>
        <tr>
            <td>商业面积(㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.BizArea)
            </td>
            <td>工业面积(㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.IndustryArea)
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.BizArea)
            </td>
            <td></td>
            <td>
                @Html.ValidationMessageFor(m => m.IndustryArea)
            </td>
        </tr>
        <tr>
            <td>管理费(可写范围):
            </td>
            <td>
                @Html.TextBoxFor(m => m.ManagerPrice)
            </td>
            <td>管理处电话:
            </td>
            <td>
                @Html.TextBoxFor(m => m.ManagerTel)
            </td>
        </tr>
        <tr>
            <td>交通便捷度:
            </td>
            <td>
                @Html.DropDownListFor(m => m.TrafficType, ViewBag.TrafficTypeName as List<SelectListItem>)
            </td>
            <td>交通便捷度描述:
            </td>
            <td>
                @Html.TextBoxFor(m => m.TrafficDetails)
            </td>
        </tr>
        <tr>
            <td>停车便捷度:
            </td>
            <td>
                @Html.DropDownListFor(m => m.ParkingLevel, ViewBag.ParkingLevelName as List<SelectListItem>)
            </td>
            <td>车位类型:
            </td>
            <td>
                @Html.DropDownListFor(m => m.ParkingType, ViewBag.ParkingTypeName as List<SelectListItem>)
            </td>
        </tr>
        <tr>
            <td>停车费(可写范围):
            </td>
            <td>
                @Html.TextBoxFor(m => m.ParkingPrice)
            </td>
            <td>租售方式:
            </td>
            <td>
                @Html.DropDownListFor(m => m.RentSaleType, ViewBag.RentSaleTypeName as List<SelectListItem>)
            </td>
        </tr>
        <tr>
            <td>空调系统类型:
            </td>
            <td>
                @Html.DropDownListFor(m => m.AirConditionType, ViewBag.AirConditionTypeName as List<SelectListItem>)
            </td>
            <td>项目概况:
            </td>
            <td>
                @Html.TextBoxFor(m => m.Details)
            </td>
        </tr>
        <tr>
            <td>四至东:
            </td>
            <td>
                @Html.TextBoxFor(m => m.East)
            </td>
            <td>四至南:
            </td>
            <td>
                @Html.TextBoxFor(m => m.south)
            </td>
        </tr>
        <tr>
            <td>四至西:
            </td>
            <td>
                @Html.TextBoxFor(m => m.west)
            </td>
            <td>四至北:
            </td>
            <td>
                @Html.TextBoxFor(m => m.north)
            </td>
        </tr>
        <tr>
            <td>拼音简写:
            </td>
            <td>
                @Html.TextBoxFor(m => m.PinYin)
            </td>
            <td>楼盘名称全拼:
            </td>
            <td>
                @Html.TextBoxFor(m => m.PinYinAll)
            </td>
        </tr>
        <tr>
            <td>X坐标:
            </td>
            <td>
                @Html.TextBoxFor(m => m.X, new { @readonly = "readonly" })
            </td>
            <td>Y坐标:
            </td>
            <td>
                @Html.TextBoxFor(m => m.Y, new { @readonly = "readonly" })
                <a href="javascript:void(0)" id="GetCoordinate">拾取坐标</a>
            </td>
        </tr>
        <tr>
            <td>
                土地使用年限(年):
            </td>
            <td>
                @Html.TextBoxFor(m => m.UsableYear)
            </td>
            <td>备注:
            </td>
            <td colspan="3">
                @Html.TextBoxFor(m => m.Remarks)
            </td>
        </tr>
        <tr>
            <td>楼盘均价(元/㎡):
            </td>
            <td>
                @Html.TextBoxFor(m => m.AveragePrice)
                @Html.ValidationMessageFor(m => m.AveragePrice)
                @Html.HiddenFor(m=>m.Weight)
            </td>
        </tr>
        <tr>
            <td colspan="4" style="padding-top: 10px;">
                <a id="btnSave" class="btn blue" title='保存'><i class="icon-ok"></i>保存</a>
                @if (Model != null)
                {
                    <a class="btn dark" href="@Url.Action("OfficeProjectPicture", new { projectId = Model.ProjectId })" title='办公楼盘照片'><i class="icon-picture"></i>办公楼盘照片</a>
                    <a class="btn" target="_blank" href="@Url.Action("Index", "OfficePeitao", new { projectId = Model.ProjectId })" title='办公商务配套'><i class="icon-share-alt"></i>办公商务配套</a>
                    <a class="btn " target="_blank" href="@Url.Action("Index", "OfficeBuilding", new { ProjectId = Model.ProjectId })"><i class=" icon-share-alt"></i>办公楼栋</a>
                }
            </td>
        </tr>
    </table>
}
<div id="baidumap" style="display: none;">
    <div style="width: 100%">
        <div style="margin-top: 10px; margin-left: 20px; float: left; width: 100%">
            城市或地名:
            <input id="txtarea" type="text" style="width: 100px;" />&nbsp;&nbsp;<a class="btn" id="areaSearch">搜索<i class="icon-search"></i></a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="javascript:void(0)" id="btn_xy" class="btn">确定</a>
            <a href="javascript:void(0)" id="btnClrearCallout" class="btn">取消</a>
        </div>
    </div>
    <div style="width: 860px; height: 450px; border: 1px solid gray; text-align: center;" id="container">
    </div>
</div>
