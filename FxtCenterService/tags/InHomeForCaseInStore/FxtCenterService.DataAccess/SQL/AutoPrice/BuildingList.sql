select ProjectId,UnitsNumber, BuildingId,BuildingName,TotalBuildArea,c.CodeName as PurposeName,TotalFloor, TotalNumber,BuildDate,IsEValue,weight,doorplate from @table_building b with(nolock) left join FxtDataCenter.dbo.SYS_Code as c with(nolock) on b.BuildingTypeCode=c.Code  where valid=1 and  ProjectId=@projectid and CityID=@cityid @key and BuildingId not in(select BuildingId from @table_building_sub ps with(nolock) where ps.ProjectId=b.ProjectId and ps.Fxt_CompanyId=@fxtcompanyid and ps.CityId=b.CityId) AND b.FxtCompanyId IN (SELECT value FROM  dbo.SplitToTable((SELECT ShowCompanyId FROM FxtDataCenter.dbo.Privi_Company_ShowData WHERE CityId=@cityid AND FxtCompanyId=@fxtcompanyid and TypeCode = @typecode),',')) 
union 
select ProjectId,UnitsNumber, BuildingId,BuildingName,TotalBuildArea,c.CodeName as PurposeName,TotalFloor, TotalNumber,BuildDate,IsEValue,weight,doorplate from @table_building_sub b with(nolock) left join FxtDataCenter.dbo.SYS_Code as c with(nolock) on b.BuildingTypeCode=c.Code where valid=1 and ProjectId=@projectid @key and CityID=@cityid and b.Fxt_CompanyId=@fxtcompanyid  